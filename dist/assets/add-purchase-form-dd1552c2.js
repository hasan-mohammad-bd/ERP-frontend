import{B as te,r as I,dx as re,dy as ne,dz as le,E as oe,G as ie,dn as M,ad as c,bR as ce,dA as de,dB as ue,dp as xe,dq as b,a as e,aL as me,X as p,J as he,Y as W,aX as G,K as d,N as u,Q as x,b3 as je,V as f,b4 as pe,b5 as ye,b6 as ge,b8 as ve,W as m,ab as q,ac as D,aY as k,ae as A,af as E,I as Q,bx as _e,dr as be,ds as fe,dC as Se,ax as L,ay as Pe}from"./index-51361ed7.js";function Ne(){const S=te(),[i,V]=I.useState([]),[P,$]=I.useState({sales_order_date:!1,delivery_date:!1,due_date:!1}),w=a=>{$(s=>({...s,[a]:!s[a]}))},{data:N,isLoading:R}=re("page=1&per_page=1000"),{data:C,isLoading:U}=ne("page=1&per_page=1000"),X=(N==null?void 0:N.data)||[],Y=(C==null?void 0:C.data)||[],[J,{isLoading:H}]=le(),t=oe({resolver:ie(Se),defaultValues:{total:0,discount:0,tax_type:M[1].id.toString(),date:c(new Date,"yyyy-MM-dd")}}),K=ce(),T=Number(K.id),{data:F}=de(T,{skip:!T}),[Z,{isLoading:ee}]=ue(),r=(F==null?void 0:F.data)||void 0;I.useEffect(()=>{var a,s,n;if(r){const o=r.details.map(l=>{var g,v,z,O;return{detailId:l.id,barcodeId:(g=l.item_barcode)==null?void 0:g.id,quantity:l.qty,used_qty:l.used_qty,available_qty:l.available_qty,price:l.price,tax:l.tax||void 0,units:[],unit:l.unit,barcode:(v=l.item_barcode)==null?void 0:v.barcode,name:(z=l.item)==null?void 0:z.name,barcodeAttribute:(O=l.item_barcode)==null?void 0:O.barcode_attribute,note:l.note}});V(o),t.reset({discount:r.discount,tax_type:r.tax_type,total:r.total,contact_id:String((a=r.contact)==null?void 0:a.id),date:r.date||"",due_date:r.due_date||"",delivery_date:r.delivery_date||"",note:r.note||"",terms_conditions:r.terms_conditions||"",sub_total:r.sub_total,reference:r.reference||"",tax:r.tax,warehouse_id:(s=r.warehouse)==null?void 0:s.id,purchase_order_id:(n=r.purchase_order)==null?void 0:n.id})}},[r,t]);const ae=t.watch("discount"),B=t.watch("tax_type");let h=0,y=0,j=0;i&&i.length>0&&(i==null||i.forEach(a=>{var g,v;const s=a.price*a.quantity,n=s*(ae??0)/100,o=s-n,l=B==="inclusive"?xe(o,((g=a.tax)==null?void 0:g.amount)||0):o*(((v=a.tax)==null?void 0:v.amount)||0)/100;h+=s,y+=n,j+=l}));let _=h-y+(B==="inclusive"?0:j);h=b(h),y=b(y),j=b(j),_=b(_),t.setValue("sub_total",h),t.setValue("tax",j),t.setValue("total",_);async function se(a){if(i.length===0)return L.error("Please select at least one product");const s={...a,details:i.map(n=>{var o;return{details_id:n.detailId,item_barcode_id:n.barcodeId,tax_id:(o=n.tax)==null?void 0:o.id,unit_id:n.unit.id,qty:n.quantity,price:n.price,total:n.price*n.quantity,note:n.note||""}})};console.log(s,"payload");try{r?(await Z({purchaseId:T,updatedPurchase:s}).unwrap(),L.success("Purchase updated successfully")):(await J(s).unwrap(),L.success("Purchase created successfully")),S("/billing/purchases")}catch(n){Pe(n)}}return console.log(t.formState.errors,"form errors"),e.jsx(e.Fragment,{children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx(me,{title:r?"Edit Purchase":"Add Purchase",description:"Manage your sub accounts for you business"}),e.jsx(p,{onClick:()=>S("/billing/purchases"),size:"sm",children:"Purchase List"})]}),e.jsx(he,{...t,children:e.jsxs("form",{onSubmit:t.handleSubmit(se),className:"space-y-3 mb-4  overflow-y-scroll no-scrollbar",children:[e.jsx("div",{className:"",children:e.jsx(W,{className:"p-3",children:e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(G,{loading:R,data:X,displayField:"name",valueField:"id",form:t,name:"contact_id",placeholder:"Select Supplier",title:"Supplier Name",className:"w-full"}),e.jsx(G,{loading:U,data:Y,displayField:"name",valueField:"id",form:t,name:"warehouse_id",placeholder:"Select Warehouse",title:"Warehouse",className:"w-full"}),e.jsx("div",{className:"w-full",children:e.jsx(d,{control:t.control,name:"tax_type",render:({field:a})=>{var s,n,o;return e.jsxs(u,{children:[e.jsx(x,{children:"Tax Type"}),e.jsxs(je,{onValueChange:a.onChange,defaultValue:String((n=(s=M)==null?void 0:s[1])==null?void 0:n.id),children:[e.jsx(f,{children:e.jsx(pe,{children:e.jsx(ye,{placeholder:"Select Tax Type"})})}),e.jsx(ge,{children:(o=M)==null?void 0:o.map(l=>e.jsx(ve,{value:String(l.id),children:l.name},l.id))})]}),e.jsx(m,{})]})}})}),e.jsx(d,{control:t.control,name:"date",render:({field:a})=>e.jsxs(u,{children:[e.jsx(x,{children:"Date"}),e.jsxs(q,{open:P.sales_order_date,onOpenChange:()=>w("sales_order_date"),children:[e.jsx(D,{asChild:!0,children:e.jsxs(p,{variant:"outline",className:`w-full justify-start text-left font-normal ${!a.value&&"text-muted-foreground"}`,children:[a.value?c(a.value,"PP"):"Pick a date",e.jsx(k,{className:"ml-auto h-4 w-4 opacity-50"})]})}),e.jsx(A,{className:"w-auto p-0 z-[200]",align:"start",children:e.jsx(E,{mode:"single",selected:a.value?new Date(a.value):void 0,onSelect:s=>{a.onChange(s?c(s,"yyyy-MM-dd"):"")},initialFocus:!0})})]}),e.jsx(m,{})]})}),e.jsx(d,{control:t.control,name:"due_date",render:({field:a})=>e.jsxs(u,{children:[e.jsx(x,{children:"Due Date"}),e.jsxs(q,{open:P.due_date,onOpenChange:()=>w("due_date"),children:[e.jsx(D,{asChild:!0,children:e.jsxs(p,{variant:"outline",className:`w-full justify-start text-left font-normal ${!a.value&&"text-muted-foreground"}`,children:[a.value?c(a.value,"PP"):"Pick a date",e.jsx(k,{className:"ml-auto h-4 w-4 opacity-50"})]})}),e.jsx(A,{className:"w-auto p-0 z-[200]",align:"start",children:e.jsx(E,{mode:"single",selected:a.value?new Date(a.value):void 0,onSelect:s=>{a.onChange(s?c(s,"yyyy-MM-dd"):"")},initialFocus:!0})})]}),e.jsx(m,{})]})}),e.jsx(d,{control:t.control,name:"delivery_date",render:({field:a})=>e.jsxs(u,{children:[e.jsx(x,{children:"Delivery Date"}),e.jsxs(q,{open:P.delivery_date,onOpenChange:()=>w("delivery_date"),children:[e.jsx(D,{asChild:!0,children:e.jsxs(p,{variant:"outline",className:`w-full justify-start text-left font-normal ${!a.value&&"text-muted-foreground"}`,children:[a.value?c(a.value,"PP"):"Pick a date",e.jsx(k,{className:"ml-auto h-4 w-4 opacity-50"})]})}),e.jsx(A,{className:"w-auto p-0 z-[200]",align:"start",children:e.jsx(E,{mode:"single",selected:a.value?new Date(a.value):void 0,onSelect:s=>{a.onChange(s?c(s,"yyyy-MM-dd"):"")},initialFocus:!0})})]}),e.jsx(m,{})]})}),e.jsx(d,{control:t.control,name:"reference",render:({field:a})=>e.jsxs(u,{children:[e.jsx(x,{children:"Reference"}),e.jsx(f,{children:e.jsx(Q,{placeholder:"Enter reference",...a})}),e.jsx(m,{})]})}),e.jsx(d,{control:t.control,name:"note",render:({field:a})=>e.jsxs(u,{children:[e.jsx(x,{children:"Note"}),e.jsx(f,{children:e.jsx(Q,{placeholder:"Type Note.",...a})}),e.jsx(m,{})]})}),e.jsx(d,{control:t.control,name:"terms_conditions",render:({field:a})=>e.jsxs(u,{children:[e.jsx(x,{children:"Terms and conditions"}),e.jsx(f,{children:e.jsx(_e,{placeholder:"Type terms and conditions.",...a})}),e.jsx(m,{})]})})]})})}),e.jsx(W,{className:"mb-4",children:e.jsx(be,{setSelectedProducts:V,selectedProducts:i,usedFor:"purchase"})}),e.jsx("div",{className:"flex justify-end",children:e.jsx(fe,{form:t,subTotal:h,discountedAmount:y,totalTaxAmount:j,grandTotal:_})}),e.jsxs("div",{className:"text-right",children:[e.jsx(p,{type:"button",onClick:()=>S("/billing/purchases"),className:"mr-2",variant:"primary",children:"Cancel"}),e.jsx(p,{disabled:!t.formState.isValid||H||ee,variant:"default",type:"submit",className:"w-fit mt-4",children:r?"Update":"Add"})]})]})})]})})}export{Ne as default};
